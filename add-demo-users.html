<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Demo Users - Performance Review System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .demo-users {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .demo-users h3 {
        margin-top: 0;
        color: #495057;
      }
      .user-item {
        background: white;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid #007bff;
      }
      .user-email {
        font-weight: bold;
        color: #007bff;
      }
      .user-role {
        color: #6c757d;
        font-size: 0.9em;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #bee5eb;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
      }
      .config {
        background: #e9ecef;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .config input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .config label {
        font-weight: bold;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Add Demo Users to NocoDB</h1>

      <div class="config">
        <h3>Configuration</h3>
        <label for="apiToken">API Token:</label>
        <input
          type="text"
          id="apiToken"
          value="irgoNvr19kYwti4DgHXCViGXPA2yc449fdEdZh5u"
          placeholder="Enter your NocoDB API token"
        />

        <label for="tableId">Users Table ID:</label>
        <input
          type="text"
          id="tableId"
          value="m3h0p1bnzzmkf80"
          placeholder="Enter your users table ID"
        />

        <label for="viewId">Users View ID:</label>
        <input
          type="text"
          id="viewId"
          value="vw6pbzs0npnd44ad"
          placeholder="Enter your users view ID"
        />
      </div>

      <div class="demo-users">
        <h3>Demo Users to Add</h3>
        <div class="user-item">
          <div class="user-email">employee@company.com</div>
          <div class="user-role">Role: EMPLOYEE | Password: password123</div>
        </div>
        <div class="user-item">
          <div class="user-email">manager@company.com</div>
          <div class="user-role">Role: MANAGER | Password: password123</div>
        </div>
        <div class="user-item">
          <div class="user-email">hr@company.com</div>
          <div class="user-role">Role: HR | Password: password123</div>
        </div>
        <div class="user-item">
          <div class="user-email">admin@company.com</div>
          <div class="user-role">Role: ADMIN | Password: password123</div>
        </div>
        <div class="user-item">
          <div class="user-email">committee@company.com</div>
          <div class="user-role">
            Role: COMMITTEE_MEMBER | Password: password123
          </div>
        </div>
      </div>

      <div style="text-align: center">
        <button onclick="checkConnection()">üîç Test Connection</button>
        <button onclick="addAllUsers()">‚ûï Add All Demo Users</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
      </div>

      <div id="messages"></div>

      <div class="log">
        <div id="log"></div>
      </div>
    </div>

    <script>
      const NOCODB_BASE_URL = "http://localhost:8080";

      // Demo users data
      const demoUsers = [
        {
          email: "employee@company.com",
          password: "password123",
          firstName: "John",
          lastName: "Employee",
          role: "EMPLOYEE",
          position: "Software Developer",
          department: "Engineering",
          currentGrade: "L2",
          managerId: null, // Will be set after manager is created
          hireDate: "2023-01-15",
          isActive: true,
        },
        {
          email: "manager@company.com",
          password: "password123",
          firstName: "Jane",
          lastName: "Manager",
          role: "MANAGER",
          position: "Engineering Manager",
          department: "Engineering",
          currentGrade: "L4",
          managerId: null,
          hireDate: "2022-06-01",
          isActive: true,
        },
        {
          email: "hr@company.com",
          password: "password123",
          firstName: "Bob",
          lastName: "HR",
          role: "HR",
          position: "HR Specialist",
          department: "Human Resources",
          currentGrade: "L3",
          managerId: null,
          hireDate: "2022-03-15",
          isActive: true,
        },
        {
          email: "admin@company.com",
          password: "password123",
          firstName: "Alice",
          lastName: "Admin",
          role: "ADMIN",
          position: "System Administrator",
          department: "IT",
          currentGrade: "L5",
          managerId: null,
          hireDate: "2021-12-01",
          isActive: true,
        },
        {
          email: "committee@company.com",
          password: "password123",
          firstName: "Charlie",
          lastName: "Committee",
          role: "COMMITTEE_MEMBER",
          position: "Senior Engineer",
          department: "Engineering",
          currentGrade: "L5",
          managerId: null, // Will be set after manager is created
          hireDate: "2021-09-01",
          isActive: true,
        },
      ];

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.style.color =
          type === "error"
            ? "#dc3545"
            : type === "success"
            ? "#28a745"
            : "#6c757d";
        logEntry.textContent = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function showMessage(message, type = "info") {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = type;
        messageDiv.textContent = message;
        messagesDiv.appendChild(messageDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }

      function getConfig() {
        return {
          apiToken: document.getElementById("apiToken").value.trim(),
          tableId: document.getElementById("tableId").value.trim(),
          viewId: document.getElementById("viewId").value.trim(),
        };
      }

      async function checkConnection() {
        const config = getConfig();
        log("üîç Testing connection to NocoDB...");

        try {
          const response = await fetch(`${NOCODB_BASE_URL}/api/v2/tables`, {
            headers: {
              "xc-token": config.apiToken,
            },
          });

          if (response.ok) {
            const tables = await response.json();
            log(
              `‚úÖ Connection successful! Found ${
                tables.list?.length || 0
              } tables`
            );

            // Check if users table exists
            const usersTable = tables.list?.find(
              (table) => table.id === config.tableId
            );
            if (usersTable) {
              log(`‚úÖ Users table found: ${usersTable.table_name}`);
              showMessage(
                "Connection successful! Users table found.",
                "success"
              );
            } else {
              log(`‚ùå Users table with ID ${config.tableId} not found`);
              showMessage(
                "Connection successful, but users table not found. Check the table ID.",
                "error"
              );
            }
          } else {
            const error = await response.text();
            log(
              `‚ùå Connection failed: ${response.status} ${response.statusText}`
            );
            log(`Error details: ${error}`);
            showMessage("Connection failed. Check your API token.", "error");
          }
        } catch (error) {
          log(`‚ùå Connection error: ${error.message}`);
          showMessage("Connection error. Check if NocoDB is running.", "error");
        }
      }

      async function addUser(userData, config) {
        try {
          const response = await fetch(
            `${NOCODB_BASE_URL}/api/v2/tables/${config.tableId}/records`,
            {
              method: "POST",
              headers: {
                "xc-token": config.apiToken,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            }
          );

          if (response.ok) {
            const result = await response.json();
            log(`‚úÖ Added user: ${userData.email} (ID: ${result.id})`);
            return result;
          } else {
            const error = await response.text();
            log(
              `‚ùå Failed to add user ${userData.email}: ${response.status} ${response.statusText}`
            );
            log(`Error details: ${error}`);
            return null;
          }
        } catch (error) {
          log(`‚ùå Error adding user ${userData.email}: ${error.message}`);
          return null;
        }
      }

      async function addAllUsers() {
        const config = getConfig();

        if (!config.apiToken || !config.tableId) {
          showMessage("Please fill in all configuration fields.", "error");
          return;
        }

        log("üöÄ Starting to add demo users...");
        showMessage("Adding demo users...", "info");

        let successCount = 0;
        let failCount = 0;

        // First, add users without manager references
        const usersToAdd = [...demoUsers];

        for (let i = 0; i < usersToAdd.length; i++) {
          const user = usersToAdd[i];
          log(`üìù Adding user ${i + 1}/${usersToAdd.length}: ${user.email}`);

          const result = await addUser(user, config);

          if (result) {
            successCount++;
            // Store the ID for manager references
            user.nocodbId = result.id;
          } else {
            failCount++;
          }

          // Small delay between requests
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        // Now update users with manager references
        log("üîó Updating manager references...");

        const manager = usersToAdd.find((u) => u.role === "MANAGER");
        if (manager && manager.nocodbId) {
          const employee = usersToAdd.find((u) => u.role === "EMPLOYEE");
          const committee = usersToAdd.find(
            (u) => u.role === "COMMITTEE_MEMBER"
          );

          if (employee && employee.nocodbId) {
            await updateUserManager(
              employee.nocodbId,
              manager.nocodbId,
              config
            );
          }

          if (committee && committee.nocodbId) {
            await updateUserManager(
              committee.nocodbId,
              manager.nocodbId,
              config
            );
          }
        }

        log(
          `‚ú® Finished! Successfully added ${successCount} users, ${failCount} failed.`
        );

        if (successCount > 0) {
          showMessage(
            `Successfully added ${successCount} demo users!`,
            "success"
          );
        } else {
          showMessage(
            "Failed to add any users. Check the log for details.",
            "error"
          );
        }
      }

      async function updateUserManager(userId, managerId, config) {
        try {
          const response = await fetch(
            `${NOCODB_BASE_URL}/api/v2/tables/${config.tableId}/records?where=(id,eq,${userId})`,
            {
              method: "PATCH",
              headers: {
                "xc-token": config.apiToken,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ managerId: managerId.toString() }),
            }
          );

          if (response.ok) {
            log(`‚úÖ Updated manager reference for user ${userId}`);
          } else {
            log(`‚ùå Failed to update manager reference for user ${userId}`);
          }
        } catch (error) {
          log(`‚ùå Error updating manager reference: ${error.message}`);
        }
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
        document.getElementById("messages").innerHTML = "";
      }

      // Initialize
      log("üöÄ Demo Users Setup Tool Ready");
      log(
        'Configure your NocoDB settings above and click "Test Connection" to start'
      );
    </script>
  </body>
</html>
